FROM composer as composer_builder
WORKDIR /var/www/project
COPY composer.* ./
COPY .env* ./

RUN composer install --no-dev --optimize-autoloader --no-scripts
RUN composer dump-env prod

FROM php:8.0-fpm-buster

ARG PHP_TIMEZONE
ARG PHP_MEMORY_LIMIT

RUN apt-get update \
        && apt-get upgrade -y \
        && apt-get install -y \
        libicu-dev \
        libzip-dev

# Install PHP extensions
RUN docker-php-ext-install -j$(nproc) \
        pdo \
        pdo_mysql \
        opcache \
        zip \
        intl

RUN pecl install \
    xdebug \
    apcu

RUN docker-php-ext-enable \
    xdebug \
    apcu


# Set timezone
RUN ln -snf /usr/share/zoneinfo/Europe/Berlin /etc/localtime && echo Europe/Belin > /etc/timezone

# Copy php config.
COPY ./docker/prod/php/conf.d/* /usr/local/etc/php/conf.d/

# Copy application data.
COPY ./ /var/www/project

# Copy vendor folder generated by composer builder
COPY --from=composer_builder /var/www/project/vendor /var/www/project/vendor

# Copy dumped env php file
COPY --from=composer_builder /var/www/project/.env.local.php /var/www/project/.env.local.php

# Set permissions
RUN chown -R www-data:www-data /var/www/project

RUN chmod +x /var/www/project/bin/console

# Set default workdir
WORKDIR /var/www/project

# Set default user
USER www-data

# Run symfony scripts
RUN /var/www/project/bin/console cache:clear && /var/www/project/bin/console assets:install
